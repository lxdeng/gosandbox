name: Push Image
on:
  repository_dispatch:
    types: [build-completed]

jobs:
  push-image:
    name: push
    runs-on: ubuntu-latest

    steps:
    - name: checkout HEAD
      uses: actions/checkout@v3

    - name: push docker image
      run: |
        echo "test"
        echo "push target: \"${{ github.event.client_payload.push_target }}\""

    - id: gcloud-credentials
      name: setup gcloud credentials
      uses: 'google-github-actions/auth@v0'
      with:
        project_id: ldeng-d6886e29
        credentials_json: ${{ secrets.GCP_JSON_KEY }}
        create_credentials_file: true
        cleanup_credentials: true

    - name: setup gcloud sdk
      uses: google-github-actions/setup-gcloud@v0
      with:
        project_id: ldeng-d6886e29

    - name: gcloud auth list
      run: |
        echo "$ gcloud auth list: "
        gcloud auth list
    
    - name: login to gcr
      uses: docker/login-action@v1
      with:
        registry: gcr.io
        username: _json_key
        password: ${{ secrets.GCP_JSON_KEY }}

    - name: Create Events Dataflow Flex Template Json
      if: github.event.client_payload.push_target == '//events/dataflow:image.push'
      run: |
        echo "$TEMPLATE_PATH_PREFIX-${{ github.event.client_payload.source_sha }}.json" 
        echo "$TEMPLATE_IMAGE:${{ github.event.client_payload.source_sha }}"
      env:
        TEMPLATE_IMAGE: "gcr.io/fintech-solutions/events/dataflow"
        TEMPLATE_PATH_PREFIX: "gs://dataflow-templates/flex-templates/events/dataflow/pubsub-streaming"
